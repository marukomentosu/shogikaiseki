<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML„Éû„É≥„ÅÆÂ∞ÜÊ£ãÊ§úË®éÁõ§ v3.0</title>
    <style>
        :root {
            --board-color: #f3cca0;
            --line-color: #5d4037;
            --piece-color: #fdf5e6;
            --highlight: rgba(255, 215, 0, 0.5);
            --last-move: rgba(0, 255, 0, 0.3);
            --btn-blue: #3498db;
            --btn-green: #2ecc71;
            --btn-orange: #e67e22;
        }
        body {
            font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        h1 { margin-bottom: 5px; font-weight: normal; font-size: 24px; }
        
        /* Board Styles */
        .shogi-board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: 360px; height: 400px;
            background-color: var(--board-color);
            border: 4px solid #3e2723;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            margin: 10px 0;
            position: relative;
        }
        .cell {
            border: 1px solid var(--line-color);
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; cursor: pointer; user-select: none; position: relative;
        }
        .piece {
            width: 85%; height: 90%; background-color: var(--piece-color);
            clip-path: polygon(50% 0%, 100% 15%, 85% 100%, 15% 100%, 0% 15%);
            display: flex; justify-content: center; align-items: flex-end;
            padding-bottom: 2px; box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            font-weight: bold; color: black; line-height: 1; z-index: 2;
        }
        .piece.gote { transform: rotate(180deg); }
        .piece.selected { background-color: #ffd700; }
        
        .cell.last-move-src { background-color: var(--last-move); }
        .cell.last-move-dst { background-color: var(--highlight); }

        /* Komadai */
        .komadai-container { width: 360px; display: flex; justify-content: space-between; }
        .komadai {
            background-color: #8d6e63; width: 100%; height: 40px;
            display: flex; align-items: center; padding: 2px; gap: 2px;
            border-radius: 4px; overflow-x: auto;
        }
        .komadai-piece {
            background-color: var(--piece-color); padding: 0 4px;
            border-radius: 2px; cursor: pointer; color: black; font-size: 12px;
            position: relative; height: 30px; display: flex; align-items: center;
        }
        .komadai-piece span {
            position: absolute; top: -5px; right: -5px; background: red; color: white;
            border-radius: 50%; font-size: 10px; width: 14px; height: 14px;
            display: flex; justify-content: center; align-items: center;
        }

        /* Controls */
        .kifu-controls { display: flex; gap: 10px; margin: 10px 0; align-items: center; }
        .wars-link-area {
            background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;
            margin-bottom: 10px; width: 360px; box-sizing: border-box; text-align: center;
        }

        button {
            padding: 6px 12px; border: none; border-radius: 4px;
            background-color: var(--btn-blue); color: white; cursor: pointer; font-size: 14px;
            transition: 0.2s;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: translateY(1px); }
        button.green { background-color: var(--btn-green); font-weight: bold; }
        button.secondary { background-color: var(--btn-orange); }
        button:disabled { background-color: #7f8c8d; cursor: not-allowed; transform: none; }

        input[type="text"] {
            padding: 6px; border-radius: 4px; border: none; font-size: 14px; width: 120px;
        }
        textarea {
            width: 360px; height: 50px; padding: 8px; margin-top: 5px;
            border-radius: 4px; border: none; font-family: monospace; font-size: 10px;
            box-sizing: border-box;
        }
        .status { font-size: 14px; color: #ecf0f1; font-weight: bold; min-width: 50px; text-align: center; }
        
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(46, 204, 113, 0.9); color: white; padding: 10px 20px;
            border-radius: 20px; display: none; z-index: 100;
        }
    </style>
</head>
<body>
    <div id="toast" class="toast">Ë™≠ËæºÂÆå‰∫ÜÔºÅ</div>

    <h1>Â∞ÜÊ£ãÊ£ãË≠úËß£Êûê v3.0</h1>

    <div class="wars-link-area">
        <div style="margin-bottom: 5px; font-size:13px;">Â∞ÜÊ£ã„Ç¶„Ç©„Éº„Ç∫ID„ÇíÂÖ•Âäõ</div>
        <input type="text" id="warsId" placeholder="User_ID" onchange="saveId()">
        <button class="secondary" onclick="openWarsSearch()">Ê§úÁ¥¢„Çµ„Ç§„Éà„ÇíÈñã„Åè</button>
        <div style="font-size: 10px; margin-top:5px; color:#ccc;">
            ‚ÄªÂà•„Çø„Éñ„Åß„ÄåÊ£ãË≠úÊ§úÁ¥¢„Äç„ÅåÈñã„Åç„Åæ„Åô„ÄÇSFEN„Çí„Ç≥„Éî„Éº„Åó„Å¶Êàª„Å£„Å¶„Åç„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        </div>
    </div>

    <div class="komadai-container">
        <div style="font-size: 12px;">‚ñ≥ ÂæåÊâã</div>
        <div style="font-size: 12px;">‚ñ≤ ÂÖàÊâã</div>
    </div>
    <div class="komadai" id="komadai-gote"></div>
    <div class="shogi-board" id="board"></div>
    <div class="komadai" id="komadai-sente"></div>

    <div class="kifu-controls">
        <button onclick="changeMove(-999)">|&lt;</button>
        <button onclick="changeMove(-1)">&lt;</button>
        <span id="moveStatus" class="status">0ÊâãÁõÆ</span>
        <button onclick="changeMove(1)">&gt;</button>
        <button onclick="changeMove(999)">&gt;|</button>
        <button onclick="flipBoard()" class="secondary">ÂõûËª¢</button>
    </div>

    <div>
        <div style="margin-bottom: 5px;">
            <button class="green" onclick="pasteAndLoad()">üìã „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Åã„ÇâË™≠Ëæº</button>
            <button onclick="clearBoard()">„ÇØ„É™„Ç¢</button>
        </div>
        <textarea id="sfenInput" placeholder="„Åì„Åì„Å´SFEN„ÇíË≤º„Çä‰ªò„Åë (position startpos moves...)"></textarea>
    </div>

<script>
    // --- Config & State ---
    const pieceMap = { 'K': 'Áéã', 'R': 'È£õ', 'B': 'Ëßí', 'G': 'Èáë', 'S': 'ÈäÄ', 'N': 'Ê°Ç', 'L': 'È¶ô', 'P': 'Ê≠©', '+R': 'Èæç', '+B': 'È¶¨', '+S': 'ÊàêÈäÄ', '+N': 'ÊàêÊ°Ç', '+L': 'ÊàêÈ¶ô', '+P': '„Å®' };
    let board = [], hands = { sente: {}, gote: {} }, moves = [], currentMoveIdx = 0;
    let selected = null, isFlipped = false;

    // --- Wars Integration ---
    function saveId() {
        const id = document.getElementById('warsId').value;
        localStorage.setItem('shogi_wars_id', id);
    }

    function loadSavedId() {
        const saved = localStorage.getItem('shogi_wars_id');
        if (saved) document.getElementById('warsId').value = saved;
    }

    function openWarsSearch() {
        const id = document.getElementById('warsId').value;
        if (!id) { alert("ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
        // Kishibato is a reliable third-party search for Wars
        const url = `https://kishibato.com/wars_kifu/?user_name=${id}`;
        window.open(url, '_blank');
    }

    async function pasteAndLoad() {
        try {
            const text = await navigator.clipboard.readText();
            if (text.includes("position") || text.includes("moves")) {
                document.getElementById('sfenInput').value = text;
                initGame(text);
                showToast("Ë™≠ËæºÊàêÂäüÔºÅ");
            } else {
                alert("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´SFEN„Çâ„Åó„ÅçÊñáÂ≠óÂàó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\nÊ§úÁ¥¢„Çµ„Ç§„Éà„Åß[SFEN„Ç≥„Éî„Éº]„ÇíÊäº„Åó„Åæ„Åó„Åü„ÅãÔºü");
            }
        } catch (err) {
            // Fallback for browsers that block clipboard access
            const inputVal = document.getElementById('sfenInput').value;
            if(inputVal) {
                initGame(inputVal);
                showToast("„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Åã„ÇâË™≠Ëæº");
            } else {
                alert("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\nÊâãÂãï„ÅßË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    // --- Core Logic (Optimized from v2) ---
    function initGame(sfen) {
        moves = []; currentMoveIdx = 0;
        const parts = sfen.trim().split(' moves ');
        let startSfen = "lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL b - 1";
        
        if (parts[0].includes('sfen')) startSfen = parts[0].replace(/^position sfen /, '');
        parseBoardSFEN(startSfen);
        
        if (parts[1]) moves = parts[1].split(' ');
        render(); updateStatus();
    }

    function parseBoardSFEN(sfen) {
        const parts = sfen.split(' ');
        const rows = parts[0].split('/');
        board = []; hands = { sente: {}, gote: {} };

        for (let r = 0; r < 9; r++) {
            let rowData = [], rowString = rows[r], charIdx = 0;
            for (let i = 0; i < rowString.length; i++) {
                let char = rowString[i];
                if (!isNaN(char)) {
                    for (let k = 0; k < parseInt(char); k++) rowData.push(null);
                } else {
                    let promote = false;
                    if (char === '+') { promote = true; char += rowString[i+1]; i++; }
                    let owner = (char === char.toUpperCase() && !char.startsWith('+')) || (char.startsWith('+') && char[1]===char[1].toUpperCase()) ? 'sente' : 'gote';
                    let rawType = char.replace('+','').toUpperCase();
                    rowData.push({ char: char, display: pieceMap[rawType]||rawType, owner: owner, isPromoted: promote });
                }
            }
            board.push(rowData);
        }
        
        // Hand parsing (Simplified)
        if (parts[2] && parts[2] !== '-') {
            let h = parts[2], n = "";
            for(let c of h) {
                if(!isNaN(c)) n += c;
                else {
                    let count = n ? parseInt(n) : 1; n = "";
                    let owner = (c===c.toUpperCase()) ? 'sente' : 'gote';
                    let type = c.toUpperCase();
                    if (!hands[owner][type]) hands[owner][type]=0;
                    hands[owner][type]+=count;
                }
            }
        }
    }

    // --- Playback ---
    function changeMove(delta) {
        if (!moves.length) return;
        let target = Math.max(0, Math.min(moves.length, currentMoveIdx + delta));
        
        // Replay from start (Reliable method)
        const input = document.getElementById('sfenInput').value;
        const startPart = input.split(' moves ')[0] || "position startpos";
        if (startPart.includes('startpos')) parseBoardSFEN("lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL b - 1");
        else parseBoardSFEN(startPart.replace(/^position sfen /, ''));

        for(let i=0; i<target; i++) applyMove(moves[i]);
        currentMoveIdx = target; selected = null; render(); updateStatus();
    }

    function applyMove(str) {
        let isDrop = str.includes('*'), promote = str.includes('+'), clean = str.replace('+','');
        if (isDrop) {
            let type = clean[0], x = 9-parseInt(clean[2]), y = clean[3].charCodeAt(0)-97;
            let owner = (hands.sente[type]>0) ? 'sente' : 'gote'; // Simple inference
            if(hands[owner][type] > 0) {
                hands[owner][type]--;
                board[y][x] = { char: (owner==='sente'?type:type.toLowerCase()), display: pieceMap[type], owner: owner };
            }
        } else {
            let sc=9-parseInt(clean[0]), sr=clean[1].charCodeAt(0)-97;
            let dc=9-parseInt(clean[2]), dr=clean[3].charCodeAt(0)-97;
            let p = board[sr][sc], t = board[dr][dc];
            if(t) {
                let capt = t.char.replace('+','').toUpperCase();
                hands[p.owner][capt] = (hands[p.owner][capt]||0) + 1;
            }
            if(promote) {
                p.char = (p.owner==='sente'?'+':'+') + p.char.replace('+',''); 
                if(p.owner==='gote') p.char = p.char.toLowerCase();
                p.display = pieceMap[p.char.replace('+','').toUpperCase()];
            }
            board[dr][dc] = p; board[sr][sc] = null;
        }
    }

    // --- Render & UI ---
    function render() {
        const b = document.getElementById('board'); b.innerHTML = '';
        let lm = (currentMoveIdx>0) ? moves[currentMoveIdx-1].replace('+','') : null;
        let lSrc={x:-1,y:-1}, lDst={x:-1,y:-1};
        
        if(lm) {
            if(lm.includes('*')) { lDst.x=9-parseInt(lm[2]); lDst.y=lm[3].charCodeAt(0)-97; }
            else {
                lSrc.x=9-parseInt(lm[0]); lSrc.y=lm[1].charCodeAt(0)-97;
                lDst.x=9-parseInt(lm[2]); lDst.y=lm[3].charCodeAt(0)-97;
            }
        }

        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                let vr = isFlipped ? 8-r : r, vc = isFlipped ? 8-c : c;
                let cell = document.createElement('div'); cell.className = 'cell';
                if(vr===lSrc.y && vc===lSrc.x) cell.classList.add('last-move-src');
                if(vr===lDst.y && vc===lDst.x) cell.classList.add('last-move-dst');
                cell.onclick = () => onCellClick(vc, vr);
                
                let p = board[vr][vc];
                if (p) {
                    let d = document.createElement('div'); d.className = `piece ${p.owner}`; d.innerText = p.display;
                    if(selected && selected.type==='board' && selected.x===vc && selected.y===vr) d.classList.add('selected');
                    cell.appendChild(d);
                }
                b.appendChild(cell);
            }
        }
        renderHand('sente'); renderHand('gote');
    }

    function renderHand(o) {
        const c = document.getElementById(`komadai-${o}`); c.innerHTML = '';
        Object.keys(hands[o]).forEach(k => {
            if (hands[o][k] > 0) {
                let d = document.createElement('div'); d.className = 'komadai-piece';
                d.innerHTML = `${pieceMap[k]}<span>${hands[o][k]}</span>`;
                d.onclick = () => { selected = {type:'hand', owner:o, piece:k}; render(); };
                if(selected && selected.type==='hand' && selected.owner===o && selected.piece===k) d.style.background='#f1c40f';
                c.appendChild(d);
            }
        });
    }

    function onCellClick(x, y) {
        // Simple manual move logic for analysis
        let t = board[y][x];
        if (selected) {
            if (selected.type === 'board') {
                if (selected.x!==x || selected.y!==y) {
                    if (t) hands[selected.ownerVal][t.char.replace('+','').toUpperCase()] = (hands[selected.ownerVal][t.char.replace('+','').toUpperCase()]||0)+1;
                    board[y][x] = board[selected.y][selected.x]; board[selected.y][selected.x] = null; selected=null;
                } else selected = null;
            } else if (selected.type === 'hand' && !t) {
                hands[selected.owner][selected.piece]--;
                let char = (selected.owner==='sente') ? selected.piece : selected.piece.toLowerCase();
                board[y][x] = { char: char, display: pieceMap[selected.piece], owner: selected.owner }; selected=null;
            }
        } else if (t) selected = { type: 'board', x: x, y: y, piece: t, ownerVal: t.owner };
        render();
    }
    
    function updateStatus() { document.getElementById('moveStatus').innerText = `${currentMoveIdx}ÊâãÁõÆ`; }
    function flipBoard() { isFlipped = !isFlipped; render(); }
    function clearBoard() { board = Array(9).fill(null).map(()=>Array(9).fill(null)); hands={sente:{},gote:{}}; moves=[]; currentMoveIdx=0; render(); updateStatus(); }
    
    // Init
    loadSavedId();
    initGame("position startpos");
</script>
</body>
</html>
